# Проектирование API для генерации контента

## Endpoint: `/api/generate`

### Метод: `POST`

### Контракт запроса

```typescript
interface GenerateRequestBody {
  url: string           // URL англоязычной статьи
  mode: 'summary' | 'thesis' | 'telegram'  // Режим генерации
}
```

### Контракт ответа

**Успешный ответ (200):**
```typescript
interface GenerateResponse {
  result: string        // Сгенерированный текст на русском языке
}
```

**Ошибка (400/500/502):**
```typescript
interface ErrorResponse {
  error: string         // Понятное сообщение об ошибке для пользователя
}
```

### Логика работы

1. **Валидация входных данных**
   - Проверка наличия и корректности `url` (формат, протокол http/https)
   - Проверка наличия и допустимости `mode` (только 'summary', 'thesis', 'telegram')
   - Возврат 400 с описанием ошибки при некорректных данных

2. **Парсинг статьи**
   - Вызов функции парсинга (переиспользование логики из `/api/parse`)
   - Извлечение `title` и `content` из статьи
   - Валидация наличия контента (минимум 100 символов)
   - Возврат 400 при ошибке парсинга или отсутствии контента

3. **Генерация через AI**
   - Формирование промпта в зависимости от `mode`
   - Вызов OpenRouter API (модель `deepseek/deepseek-chat`)
   - Обработка ответа и извлечение текста
   - Возврат 502 при ошибке AI-сервиса, 500 при внутренней ошибке

4. **Логирование**
   - Логировать начало запроса (requestId, url, mode)
   - Логировать успешный парсинг (длина контента)
   - Логировать ошибки с контекстом (requestId, тип ошибки, детали)

---

## Промпты для каждого режима

### Режим `summary` — «О чем статья?»

**Промпт:**
```
Ты — эксперт по анализу статей. Прочитай следующую статью на английском языке и напиши краткое описание на русском языке (2-4 абзаца).

Опиши:
- Основную тему и цель статьи
- Ключевые идеи и выводы автора
- Для кого статья может быть полезна

Сохрани нейтральный тон, не добавляй свои комментарии или оценки.

Заголовок статьи: {title}

Текст статьи:
{content}
```

**Ожидаемый результат:** Краткое описание статьи на русском, 2-4 абзаца, нейтральный тон.

---

### Режим `thesis` — «Тезисы»

**Промпт:**
```
Ты — эксперт по анализу статей. Прочитай следующую статью на английском языке и выдели ключевые тезисы на русском языке.

Формат ответа:
- Каждый тезис на отдельной строке
- Начинай каждый тезис с маркера "•" или "-"
- Тезисы должны быть краткими (1-2 предложения каждый)
- Выдели 5-10 самых важных тезисов
- Сохрани логическую структуру (если есть порядок изложения в статье)

Заголовок статьи: {title}

Текст статьи:
{content}
```

**Ожидаемый результат:** Список тезисов на русском, каждый с новой строки, с маркерами, 5-10 пунктов.

---

### Режим `telegram` — «Пост для Telegram»

**Промпт:**
```
Ты — копирайтер, который пишет посты для Telegram-каналов. Прочитай следующую статью на английском языке и создай готовый пост для Telegram на русском языке.

Требования к посту:
- Заголовок (первая строка, можно использовать эмодзи для привлечения внимания)
- 2-4 абзаца основного текста
- Используй короткие предложения и абзацы (Telegram лучше читается с переносами строк)
- Добавь хештеги в конце (3-5 релевантных хештегов)
- Тон: информативный, но живой и понятный
- Длина: примерно 500-800 символов (оптимально для Telegram)

Не добавляй ссылки на оригинал, не упоминай источник — только содержание статьи.

Заголовок статьи: {title}

Текст статьи:
{content}
```

**Ожидаемый результат:** Готовый пост для Telegram на русском: заголовок, текст с переносами строк, хештеги в конце, 500-800 символов.

---

## Обработка ошибок

### Типы ошибок и коды ответов

| Ситуация | HTTP код | Сообщение |
|----------|----------|-----------|
| Отсутствует `url` или `mode` | 400 | "URL статьи и режим генерации обязательны" |
| Некорректный формат URL | 400 | "Некорректный URL статьи" |
| Недопустимый `mode` | 400 | "Недопустимый режим генерации. Используйте: summary, thesis, telegram" |
| Ошибка загрузки статьи (404, timeout) | 400 | "Не удалось загрузить статью. Проверьте URL и попробуйте позже" |
| Не удалось извлечь контент | 400 | "Не удалось извлечь текст статьи. Возможно, страница не содержит статьи" |
| Контент слишком короткий (< 100 символов) | 400 | "Статья слишком короткая для обработки" |
| Отсутствует API ключ OpenRouter | 500 | "Сервис генерации не настроен" |
| Ошибка OpenRouter API (недоступность, лимиты) | 502 | "Ошибка сервиса генерации. Попробуйте позже" |
| Пустой ответ от AI | 502 | "Сервис вернул пустой результат" |
| Внутренняя ошибка сервера | 500 | "Внутренняя ошибка сервера" |

### Логирование ошибок

Все ошибки логируются с:
- `requestId` (уникальный идентификатор запроса)
- Типом ошибки и контекстом (URL, mode, детали)
- Стеком ошибки для внутренних исключений (только в логах, не в ответе клиенту)

---

## Технические детали

### Переиспользование кода

- Функции парсинга из `/api/parse/route.ts` вынести в отдельный модуль `lib/article-parser.ts`
- Функцию получения API ключа из `/api/translate/route.ts` вынести в `lib/openrouter.ts`
- Общую логику вызова OpenRouter вынести в `lib/ai-client.ts`

### Ограничения

- Максимальная длина контента для AI: 20000 символов (уже ограничено в парсере)
- `max_tokens` для OpenRouter: 2048 (достаточно для всех трёх режимов)
- Timeout для запроса к OpenRouter: 60 секунд

### Безопасность

- API ключ хранится в `process.env.OPENROUTER_API_KEY`
- Валидация всех входных данных перед обработкой
- Не логируем полный контент статьи (только длину и превью)
- Не возвращаем технические детали ошибок клиенту (только понятные сообщения)
